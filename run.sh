#!/bin/bash
# –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ AI-—Å—Ç–µ–∫–∞
# –°–æ–±–∏—Ä–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –∑–∞–ø—É—Å–∫–∞–µ—Ç –∏—Ö –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç –∑–∞–≥—Ä—É–∑–∫—É –º–æ–¥–µ–ª–µ–π

DIR="$(cd "$(dirname "$0")" && pwd)"

echo "========================================"
echo "–ó–∞–ø—É—Å–∫ AI —Å—Ç–µ–∫–∞ —Å Ollama –∏ Open WebUI"
echo "========================================"

# –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
echo ""
echo "üöÄ –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose build
docker compose up -d

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π:
# –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∂–∏–¥–∞–µ–º—ã—Ö –º–æ–¥–µ–ª–µ–π (–Ω–µ–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –≤ models.txt)
EXPECTED=$(grep -v '^#' "$DIR/models.txt" 2>/dev/null | grep -v '^$' | sed 's/#.*$//' | wc -l)

# –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
while true; do
    clear  # –û—á–∏—â–∞–µ–º —ç–∫—Ä–∞–Ω
    "$DIR/monitor.sh"  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
    echo ""

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Ollama API
    if timeout 5 curl -s http://localhost:11434/api/tags > /dev/null; then
        # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
        LOADED=$(curl -s http://localhost:11434/api/tags | grep -o '"name"' | wc -l)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –º–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        if [ "$LOADED" -ge "$EXPECTED" ]; then
            echo "‚úÖ –í—Å–µ –º–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!"
            break  # –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
        else
            echo "üìä $LOADED/$EXPECTED –º–æ–¥–µ–ª–µ–π"
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ..."
            sleep 5  # –ñ–¥—ë–º 5 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        fi
    else
        echo "‚è≥ –ó–∞–ø—É—Å–∫..."
        sleep 5  # –ñ–¥—ë–º 5 —Å–µ–∫—É–Ω–¥ –µ—Å–ª–∏ Ollama –µ—â—ë –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
    fi
done