#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ AI-—Å—Ç–µ–∫–∞
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Ollama API –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª —Ü–≤–µ—Ç–∞
if [ -t 1 ]; then
    # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤
    GREEN='\033[1;32m'  # –Ø—Ä–∫–æ-–∑–µ–ª—ë–Ω—ã–π –¥–ª—è —É—Å–ø–µ—Ö–∞
    RED='\033[1;31m'    # –Ø—Ä–∫–æ-–∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –æ—à–∏–±–æ–∫
    YELLOW='\033[1;33m' # –Ø—Ä–∫–æ-–∂—ë–ª—Ç—ã–π –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
    BLUE='\033[1;36m'   # –Ø—Ä–∫–æ-–≥–æ–ª—É–±–æ–π –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    NC='\033[0m'        # No Color
else
    # –ë–µ–∑ —Ü–≤–µ—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –≤—ã–≤–æ–¥–∞ –≤ —Ñ–∞–π–ª)
    GREEN=''
    RED=''
    YELLOW=''
    BLUE=''
    NC=''
fi

echo -e "${BLUE}=== –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤ ===${NC}"
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ Docker Compose
echo -e "${BLUE}üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:${NC}"
docker compose ps

echo ""
echo -e "${BLUE}üåê –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:${NC}"

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ Ollama API (—Ç–∞–π–º–∞—É—Ç 5 —Å–µ–∫—É–Ω–¥)
if timeout 5 curl -s http://localhost:11434/api/tags > /dev/null; then
    echo -e "${GREEN}‚úÖ Ollama API: http://localhost:11434${NC}"
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –∏—Ö –Ω–∞–∑–≤–∞–Ω–∏—è
    echo "   –ú–æ–¥–µ–ª–∏:"
    curl -s http://localhost:11434/api/tags | grep -o '"name":"[^"]*"' | sed 's/"name":"//;s/"//;s/^/     - /'
else
    echo -e "${RED}‚ùå Ollama –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç${NC}"
fi

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–∞—á–∏–≤–∞–µ–º—ã—Ö –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –º–æ–¥–µ–ª–µ–π
# –ò—â–µ–º –≤ –ª–æ–≥–∞—Ö Ollama –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–µ–π
CURRENT_DOWNLOAD=$(docker compose logs ollama --tail=15 2>/dev/null | grep -E "(pulling|downloading).*(layer|digest|%)" | tail -1)
if [ -n "$CURRENT_DOWNLOAD" ]; then
    echo ""
    echo -e "${YELLOW}üîÑ –°–µ–π—á–∞—Å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è:${NC}"
    echo "   $CURRENT_DOWNLOAD" | sed 's/^/   /'
fi